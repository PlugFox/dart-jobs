name: SERVER / DEPLOY / PRODUCTION

on:
  workflow_dispatch:
    #inputs:
    #  version:
    #    description: 'Flutter version from https://github.com/flutter/flutter/tags'
    #    required: true

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: ✨ Log into registry
        run: echo "${{ secrets.DOCKER_REGISTRY_LOGIN_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_REGISTRY_LOGIN_USERNAME }} --password-stdin https://registry.plugfox.dev

      - name: 📦 Pull dart:stable
        run: docker pull dart:stable

      - name: 🏗️ Build images
        run: make -C ./server -f ./Makefile docker-build-prod

      - name: 💾 Push images to registry
        run: make -C ./server -f ./Makefile docker-push-prod
      
      - name: 🔥 Deploy to swarm
        run: |
          INPUT_REMOTE_USER="pfx"
          INPUT_REMOTE_HOST="49.12.224.115"

          echo "Registering SSH keys..."
          mkdir -p "$HOME/.ssh"
          printf '%s' "${{ secrets.DOCKER_SWARM_SSH_PRIVATE_KEY }}" >> "${HOME}/.ssh/docker"
          chmod 600 "$HOME/.ssh/docker" && eval $(ssh-agent) && ssh-add "${HOME}/.ssh/docker"
          
          echo "Add public key to known hosts..."
          printf '%s %s\n' "$INPUT_REMOTE_HOST" "${{ secrets.DOCKER_SWARM_SSH_PUBLIC_KEY }}" >> "${HOME}/.ssh/known_hosts"

          echo "Deploying..."
          docker --log-level debug --host ssh://${INPUT_REMOTE_USER}@${INPUT_REMOTE_HOST} stack deploy --compose-file ./server/stack/dart-jobs-prod.yml --orchestrator swarm --prune --with-registry-auth dart-jobs-prod
          
          rm -rf "$HOME/.ssh"

