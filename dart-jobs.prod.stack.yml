# Deploy:
# make docker-build-prod
# make docker-push-prod
# docker --log-level debug --host "ssh://pfx@api.plugfox.dev" stack deploy --compose-file ./server/docker/dart-jobs.prod.yml --orchestrator swarm --prune --with-registry-auth dart-jobs-prod

# Logs:
# docker --log-level debug --host "ssh://pfx@api.plugfox.dev" service logs --no-task-ids -f -n all dart-jobs-prod_service

version: '3.3'

services:
  dart-jobs-service:
    image: registry.plugfox.dev/dart-jobs-service:prod
    #volumes:
    #  - /var/run/docker.sock:/var/run/docker.sock:ro
    #ports:
    #  - target: 8080
    #    published: 80
    #    mode: host
    healthcheck:
      test: curl --fail -s http://127.0.0.1:80/health || exit 1
      interval: 15s
      timeout: 10s
      retries: 3
    environment:
      PORT: 80
    networks:
      - traefik-public
      - dart-jobs
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        failure_action: rollback
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      placement:
        constraints:
          - node.role == worker
      resources:
        reservations:
          cpus: '0.15'
          memory: 128M
        limits:
          cpus: '0.25'
          memory: 512M
      labels:
        ################################################################
        # TRAEFIK CONFIG
        traefik.enable: 'true'
        traefik.docker.network: traefik-public
        traefik.constraint-label: traefik-public

        # HTTPS Router
        traefik.http.routers.dart-jobs-prod-router.tls: 'true'
        traefik.http.routers.dart-jobs-prod-router.entrypoints: https
        traefik.http.routers.dart-jobs-prod-router.tls.certresolver: le
        traefik.http.routers.dart-jobs-prod-router.rule: Host(`api.plugfox.dev`) && PathPrefix(`/jobs`)

        # Middlewares
        traefik.http.routers.dart-jobs-prod-router.middlewares: 'dart-jobs-prod-headers'

        # CORS
        traefik.http.middlewares.dart-jobs-prod-headers.headers.accesscontrolallowmethods: GET,PUT,DELETE,POST,OPTIONS
        traefik.http.middlewares.dart-jobs-prod-headers.headers.accesscontrolalloworiginlist: '*'
        traefik.http.middlewares.dart-jobs-prod-headers.headers.accesscontrolexposeheaders: '*'
        traefik.http.middlewares.dart-jobs-prod-headers.headers.accesscontrolallowheaders: '*'
        traefik.http.middlewares.dart-jobs-prod-headers.headers.accesscontrolmaxage: '60'

        # STRIP PREFIX
        #traefik.http.middlewares.dart-jobs-prod-stripprefix.stripprefix.prefixes: /jobs

        # Service
        traefik.http.routers.dart-jobs-prod-router.service: dart-jobs-prod-service
        traefik.http.services.dart-jobs-prod-service.loadbalancer.healthcheck.scheme: http
        traefik.http.services.dart-jobs-prod-service.loadbalancer.healthcheck.path: /health
        traefik.http.services.dart-jobs-prod-service.loadbalancer.healthcheck.interval: 30s
        traefik.http.services.dart-jobs-prod-service.loadbalancer.healthcheck.timeout: 3s
        traefik.http.services.dart-jobs-prod-service.loadbalancer.server.port: 80
        ################################################################

networks:
  traefik-public:
    external: true
    driver: overlay
  dart-jobs:
    driver: overlay