# Deploy:
# docker stack deploy -c /root/stack/dart-jobs-prod.yml dart-jobs-prod_echo

# Logs:
# docker service logs --no-task-ids -f -n all dart-jobs-prod_echo

version: '3.3'

dart-jobs-prod:
  echo:
    image: registry.plugfox.dev/dart-jobs-echo:prod
    #volumes:
    #  - /var/run/docker.sock:/var/run/docker.sock:ro
    #ports:
    #  - 1001:80
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 60s
      timeout: 10s
      retries: 3
    environment:
      PORT: 80
    networks:
      - traefik-public
    deploy:
      replicas: 2
      placement:
        constraints:
          - node.role == worker
      resources:
        reservations:
          cpus: '0.10'
          memory: 64M
        limits:
          cpus: '0.25'
          memory: 512M
      labels:
        ################################################################
        # TRAEFIK CONFIG
        traefik.enable: true
        traefik.docker.network: traefik-public
        traefik.constraint-label: traefik-public

        # HTTPS
        traefik.http.routers.dart-jobs-prod-echo.tls: true
        traefik.http.routers.dart-jobs-prod-echo.entrypoints: https
        traefik.http.routers.dart-jobs-prod-echo.tls.certresolver: le

        # api.plugfox.dev/prod/echo
        traefik.http.services.dart-jobs-prod-echo.loadbalancer.server.port: 80
        traefik.http.routers.dart-jobs-prod-echo.rule: Host(`api.plugfox.dev`) && PathPrefix(`/dart_jobs/prod/echo`)
        traefik.http.routers.dart-jobs-prod-echo.middlewares: dart-jobs-prod-echo-stripprefix
        traefik.http.middlewares.dart-jobs-prod-echo-stripprefix.stripprefix.prefixes: /dart_jobs/prod/echo

        # Sets the maximum request and response body to 1Mb
        traefik.http.middlewares.limit.buffering.maxRequestBodyBytes: 1000000
        traefik.http.middlewares.limit.buffering.maxResponseBodyBytes: 1000000
        ################################################################

networks:
  traefik-public:
    external: true
    driver: overlay